<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Vehicle Home â€” DApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; max-width: 980px; }
    h1,h2 { margin: 0 0 12px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    input, select, textarea, button { font-size: 14px; padding: 8px 10px; border:1px solid var(--border); border-radius:8px; }
    input[type=file]{ border:none; padding:0 }
    button { background:#111827; color:white; border:none; cursor:pointer; }
    button.ghost{ background:white; color:#111827; border:1px solid var(--border); }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .card{ border:1px solid var(--border); border-radius:14px; padding:14px; margin:12px 0; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(230px,1fr)); gap:12px; }
    .photos img{ max-height:120px; border-radius:8px; margin:6px 6px 0 0; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); }
    .badge.sold{ background:#fee2e2; border-color:#fecaca; color:#991b1b; }
    .badge.price_change{ background:#dcfce7; border-color:#bbf7d0; color:#065f46; }
    .badge.recondition{ background:#eef2ff; border-color:#e0e7ff; color:#3730a3; }
    .badge.inspection{ background:#fff7ed; border-color:#ffedd5; color:#9a3412; }
    .badge.listed_for_sale{ background:#f1f5f9; color:#334155; }
    .muted{ color:var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .status{ white-space:pre-wrap; font-size:13px; }
    a { color:#2563eb; text-decoration:none; }
    a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <h1>Vehicle Home â€” DApp</h1>

  <div class="row">
    <button id="connectBtn">ðŸ”Œ Connect MetaMask</button>
    <div id="account" class="muted"></div>
  </div>

  <div class="card grid">
    <div><b>Network:</b> Sepolia</div>
    <div><b>Contract:</b> <code id="contractAddr" class="mono"></code></div>
  </div>

  <div class="card">
    <h2>Add Record</h2>
    <div class="grid">
      <div><label>VIN<br/><input id="vin" value="5J6TF3H33CL003984"/></label></div>
      <div><label>Owner type<br/>
        <select id="owner_type">
          <option>Dealer</option><option>Owner</option><option>Auction</option>
          <option>Bank</option><option>Insurer</option><option>Government</option>
        </select></label>
      </div>
      <div><label>Owner name<br/><input id="owner_name" value="GERRY MOTORS"/></label></div>
      <div><label>Year<br/><input id="year" type="number" value="2012"/></label></div>
      <div><label>Make<br/><input id="make" value="Honda"/></label></div>
      <div><label>Model<br/><input id="model" value="Crosstour"/></label></div>
      <div><label>Trim<br/><input id="trim" value="EX-L"/></label></div>
      <div><label>Mileage<br/><input id="mileage" type="number" value="110000"/></label></div>
      <div><label>Location<br/><input id="location" value="SOUTH SAN FRANCISCO, CA"/></label></div>
      <div><label>Event type<br/>
        <select id="event_type">
          <option value="listed_for_sale">listed_for_sale</option>
          <option value="inspection">inspection</option>
          <option value="recondition">recondition</option>
          <option value="price_change">price_change</option>
          <option value="sold">sold</option>
        </select></label>
      </div>
      <div><label>Price<br/><input id="price" type="number" placeholder="e.g. 10495"/></label></div>
      <div><label>Currency<br/><input id="currency" value="USD"/></label></div>
      <div style="grid-column: 1 / -1;"><label>Note<br/><textarea id="note" rows="2" placeholder="optional"></textarea></label></div>
      <div style="grid-column: 1 / -1;">
        <label>Photos (multiple)<br/><input id="photos" type="file" accept="image/*" multiple /></label>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="addBtn">âž• Add Record</button>
      <button id="loadBtn" class="ghost">ðŸ”„ Load History</button>
    </div>
    <div id="status" class="status muted" style="margin-top:8px;"></div>
  </div>

  <div id="results"></div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  <script>
    /************  YOUR LIVE CONFIG  ************/
    const CONTRACT_ADDRESS = "0xd458fe664215466d478ECa8434a067Ee221F0B06";
    const ALCHEMY_API_URL  = "https://eth-sepolia.g.alchemy.com/v2/H-D3draiGJ6jecEzCwv8F";
    const PINATA_JWT       = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiJkYzRiYjI2ZS1lZjVlLTRhZjQtODcxZS1mMjFkNTFjMWU4MTEiLCJlbWFpbCI6ImdlcnJ5bW5tQGdtYWlsLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwaW5fcG9saWN5Ijp7InJlZ2lvbnMiOlt7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6IkZSQTEifSx7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6Ik5ZQzEifV0sInZlcnNpb24iOjF9LCJtZmFfZW5hYmxlZCI6ZmFsc2UsInN0YXR1cyI6IkFDVElWRSJ9LCJhdXRoZW50aWNhdGlvblR5cGUiOiJzY29wZWRLZXkiLCJzY29wZWRLZXlLZXkiOiIxODc4MzIzNjI0ZDgwZGZhZTRjZCIsInNjb3BlZEtleVNlY3JldCI6IjJiZDExNDAxMTBkMzRlMDE3Zjc2MzYzYzk2MDFmNDNiMjliOGVhNmZlOTBmYTE2NjU5MjBjMzY4YWZlMzBiMTkiLCJleHAiOjE3ODczOTA0NzR9.8ztOuMtze7xZgWtXzPUxpaP6jhpu8FIkof0OGF03W9k";
    /********************************************/

    const ABI = [
      "function addRecord(string vin, string ipfsCid, bytes32 dataHash) external",
      "function getRecordCount(string vin) view returns (uint256)",
      "function getRecord(string vin, uint256 index) view returns (string,string,bytes32,uint256,address)"
    ];
    document.getElementById("contractAddr").textContent = CONTRACT_ADDRESS;

    const $ = (id)=>document.getElementById(id);
    function esc(s){return (s??"").toString().replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}
    function badge(type){ return `<span class="badge ${type}">${esc(type)}</span>`; }
    async function sha256HexPrefixed(str){
      const buf=new TextEncoder().encode(str);
      const dig=await crypto.subtle.digest("SHA-256",buf);
      return "0x"+[...new Uint8Array(dig)].map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    // Pinata
    async function pinFileToIPFS(file){
      const fd=new FormData(); fd.append("file",file,file.name);
      const r=await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS",{method:"POST",body:fd,headers:{Authorization:`Bearer ${PINATA_JWT}`}});
      if(!r.ok) throw new Error("Pinata file upload failed: "+r.status);
      const d=await r.json(); return { cid:d.IpfsHash, filename:file.name };
    }
    async function pinJSONToIPFS(obj,name){
      const r=await fetch("https://api.pinata.cloud/pinning/pinJSONToIPFS",{
        method:"POST",
        headers:{"Content-Type":"application/json",Authorization:`Bearer ${PINATA_JWT}`},
        body:JSON.stringify({pinataContent:obj,pinataMetadata:{name}})
      });
      if(!r.ok) throw new Error("Pinata JSON upload failed: "+r.status);
      const d=await r.json(); return d.IpfsHash;
    }

    // Wallet
    let browserProvider, signer, account;
    async function connectWallet(){
      if(!window.ethereum){ alert("MetaMask not found"); return; }
      browserProvider = new ethers.BrowserProvider(window.ethereum);
      const chainId = await browserProvider.send("eth_chainId", []);
      if(chainId !== "0xaa36a7"){
        try{ await browserProvider.send("wallet_switchEthereumChain", [{ chainId:"0xaa36a7" }]); }
        catch(e){
          if(e.code===4902 || /Unrecognized chain ID/i.test(e.message)){
            await browserProvider.send("wallet_addEthereumChain", [{
              chainId:"0xaa36a7", chainName:"Sepolia",
              nativeCurrency:{name:"SepoliaETH",symbol:"SEP",decimals:18},
              rpcUrls:[ALCHEMY_API_URL], blockExplorerUrls:["https://sepolia.etherscan.io/"]
            }]);
          } else { throw e; }
        }
      }
      const accounts = await browserProvider.send("eth_requestAccounts", []);
      account = accounts[0]; signer = await browserProvider.getSigner();
      $("account").textContent = "Connected: " + account;
    }

    // Read history
    async function fetchJSONFromCID(cid){
      const r=await fetch("https://ipfs.io/ipfs/"+cid);
      if(!r.ok) throw new Error("IPFS fetch "+r.status);
      return await r.json();
    }
    async function loadHistory(){
      const vin=$("vin").value.trim();
      const provider=new ethers.JsonRpcProvider(ALCHEMY_API_URL);
      const c=new ethers.Contract(CONTRACT_ADDRESS,ABI,provider);
      const n=Number(await c.getRecordCount(vin));
      const el=$("results"); el.innerHTML=`<h2>VIN ${esc(vin)} â€” ${n} record(s)</h2>`;
      for(let i=0;i<n;i++){
        const [v,cid,hash,ts,sender]=await c.getRecord(vin,i);
        let json=null; try{ json=await fetchJSONFromCID(cid);}catch{}
        const ipfs=`https://ipfs.io/ipfs/${cid}`;
        const when=new Date(Number(ts)*1000).toLocaleString();
        const photos=(json?.attributes?.photos||[]).map(p=>`<a href="https://ipfs.io/ipfs/${p.cid}" target="_blank"><img src="https://ipfs.io/ipfs/${p.cid}" alt="${esc(p.filename)}"/></a>`).join("");
        $("results").insertAdjacentHTML("beforeend",`
          <div class="card">
            <div><b>#${i}</b> â€¢ <a href="${ipfs}" target="_blank">${esc(cid)}</a></div>
            <div class="mono muted">Hash: ${esc(hash)}</div>
            <div class="muted">${esc(when)} â€” ${esc(sender)}</div>
            ${json?`
              <hr/>
              <div>Owner: <b>${esc(json.owner_type)}</b> â€” ${esc(json.owner_name)}</div>
              <div>Vehicle: <b>${esc(json.attributes?.year)} ${esc(json.attributes?.make)} ${esc(json.attributes?.model)} ${esc(json.attributes?.trim||"")}</b></div>
              <div>Mileage: ${esc(json.attributes?.mileage)} â€¢ Location: ${esc(json.attributes?.location||"")}</div>
              ${json.attributes?.price?`<div>Price: <b>${esc(json.attributes.price)} ${esc(json.attributes.currency||"USD")}</b></div>`:""}
              <div style="margin:6px 0">Event: <span class="badge ${esc(json?.events?.[0]?.type||"event")}">${esc(json?.events?.[0]?.type||"event")}</span></div>
              ${photos?`<div class="photos">${photos}</div>`:""}
            `:`<div style="color:#b00">Could not fetch JSON from IPFS</div>`}
          </div>`);
      }
    }

    // Add record
    $("connectBtn").onclick=()=>connectWallet().catch(e=>alert(e.message));
    $("loadBtn").onclick   =()=>loadHistory().catch(e=>alert(e.message));
    $("addBtn").onclick    =()=>addRecord().catch(e=>alert(e.message));

    async function addRecord(){
      if(!signer) await connectWallet();
      const status=$("status"); status.textContent="Startingâ€¦";

      const vin=$("vin").value.trim();
      const ownerType=$("owner_type").value.trim();
      const ownerName=$("owner_name").value.trim();
      const year=Number($("year").value||0);
      const make=$("make").value.trim();
      const model=$("model").value.trim();
      const trim=$("trim").value.trim();
      const mileage=Number($("mileage").value||0);
      const location=$("location").value.trim();
      const eventType=$("event_type").value;
      const note=$("note").value.trim();
      const price=$("price").value?Number($("price").value):undefined;
      const currency=$("currency").value.trim()||"USD";

      // photos
      const files=[...$("photos").files];
      const photoEntries=[];
      if(files.length){
        status.textContent=`Uploading ${files.length} photo(s) to IPFSâ€¦`;
        for(let i=0;i<files.length;i++){
          const r=await pinFileToIPFS(files[i]); photoEntries.push(r);
          status.textContent+=`\n  #${i+1} ${r.filename} â†’ ${r.cid}`;
        }
      }

      const snapshot={
        schema:"vehicle-home@0.2", vin,
        owner_type:ownerType, owner_name:ownerName,
        attributes:{year,make,model,trim,mileage,location, ...(price?{price,currency}:{}) , photos:photoEntries},
        events:[{type:eventType,date:new Date().toISOString(),metadata:{note},source:"Vehicle Home DApp"}]
      };
      const json=JSON.stringify(snapshot,null,2);
      const hashHex=await sha256HexPrefixed(json);
      status.textContent+=`\nHash: ${hashHex}`;
      status.textContent+=`\nPinning JSON to IPFSâ€¦`;
      const cid=await pinJSONToIPFS(snapshot,`vehicle-home-${vin}`);
      status.textContent+=`\nCID: ${cid}\nhttps://ipfs.io/ipfs/${cid}`;

      const c=new ethers.Contract(CONTRACT_ADDRESS,ABI,signer);
      status.textContent+=`\nSending transactionâ€¦`;
      const tx=await c.addRecord(vin,cid,hashHex);
      status.textContent+=`\nTx: ${tx.hash}\nWaiting for confirmationsâ€¦`;
      const rc=await tx.wait();
      status.textContent+=`\nMined in block ${rc.blockNumber} âœ…`;

      loadHistory().catch(()=>{});
    }

    // Auto-load default VIN
    loadHistory().catch(()=>{});
  </script>
</body>
</html>
